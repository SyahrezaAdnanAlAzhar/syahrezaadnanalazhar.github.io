---
import { getCollection } from 'astro:content';
import SectionHeading from '../ui/SectionHeading.astro';

const base = import.meta.env.BASE_URL;
const baseUrl = base.endsWith('/') ? base : `${base}/`;

// Get all awards and sort by order
const allAwards = (await getCollection('awards'))
  .sort((a, b) => a.data.order - b.data.order);

const initialAwards = allAwards.slice(0, 3); // Show first 3 initially
const additionalAwards = allAwards.slice(3); // Remaining awards
---

<section id="awards" class="awards-section">
  <div class="awards-container">
    <!-- Top Spacer -->
    <div class="section-spacer-top"></div>
    
    <SectionHeading 
      title="Honors & Awards"
      showDetailButton={false}
    />

    <div class="awards-grid">
      {/* Initial 3 awards - always visible */}
      {initialAwards.map((award, index) => (
        <a 
          href={`${base}awards/${award.slug}`}
          class="award-card"
          data-initial-card
          data-award-slug={award.slug}
        >
          <!-- Organizer Logo -->
          <div class="award-logo-container">
            <img 
              src={`${baseUrl}${award.data.image}`}
              alt={award.data.organizer}
              class="award-logo"
              loading="lazy"
            />
          </div>
          
          <!-- Award Details -->
          <div class="award-details">
            <h3 class="award-title">{award.data.title}</h3>
            <p class="award-organizer">{award.data.organizer}</p>
            <p class="award-date">{award.data.date}</p>
          </div>

          <!-- Hover Overlay -->
          <div class="award-overlay">
            <span class="award-see-detail-badge">See Detail</span>
          </div>
        </a>
      ))}
      
      {/* Additional awards - hidden initially */}
      {additionalAwards.map((award, index) => (
        <a 
          href={`${base}awards/${award.slug}`}
          class="award-card award-card-hidden"
          data-additional-card
          data-award-slug={award.slug}
          style="display: none;"
        >
          <!-- Organizer Logo -->
          <div class="award-logo-container">
            <img 
              src={`${baseUrl}${award.data.image}`}
              alt={award.data.organizer}
              class="award-logo"
              loading="lazy"
            />
          </div>
          
          <!-- Award Details -->
          <div class="award-details">
            <h3 class="award-title">{award.data.title}</h3>
            <p class="award-organizer">{award.data.organizer}</p>
            <p class="award-date">{award.data.date}</p>
          </div>

          <!-- Hover Overlay -->
          <div class="award-overlay">
            <span class="award-see-detail-badge">See Detail</span>
          </div>
        </a>
      ))}
    </div>
    
    {/* Show More/Less Button */}
    {additionalAwards.length > 0 && (
      <div class="awards-toggle-container">
        <button 
          id="awards-toggle-btn"
          class="awards-toggle-btn"
          aria-expanded="false"
        >
          <svg class="toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
          <span class="toggle-text">Show More</span>
        </button>
      </div>
    )}
    
    <!-- Bottom Spacer -->
    <div class="section-spacer-bottom"></div>
  </div>
</section>

<style>
  .awards-section {
    width: 100%;
    overflow: hidden;
  }

  .awards-container {
    max-width: 72rem;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Spacers */
  .section-spacer-top {
    height: 4.5rem;
  }

  .section-spacer-bottom {
    height: 4rem;
  }

  .awards-grid {
    margin-top: 2rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  @media (max-width: 1023px) {
    .awards-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 639px) {
    .awards-grid {
      grid-template-columns: 1fr;
    }
  }

  .award-card {
    position: relative;
    display: flex;
    flex-direction: row;
    align-items: stretch;
    background: white;
    border: 2px solid #f97316;
    border-radius: 1rem;
    overflow: hidden;
    transition: all 0.3s ease;
    text-decoration: none;
    min-height: 120px;
  }

  .award-card:hover {
    transform: translateY(-8px) !important;
    box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
  }

  /* Hover Overlay */
  .award-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: calc(1rem - 2px);
    z-index: 10;
    pointer-events: none;
  }

  .award-card:hover .award-overlay {
    opacity: 1;
  }

  .award-see-detail-badge {
    padding: 0.625rem 1.25rem;
    border-radius: 9999px;
    background-color: #f97316;
    color: #ffffff;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .award-logo-container {
    flex-shrink: 0;
    width: 15%;
    min-width: 80px;
    max-width: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: white;
  }

  .award-logo {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: contain;
    border-radius: 0.5rem;
  }

  .award-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 1rem 1.25rem;
    gap: 0.25rem;
  }

  .award-title {
    font-family: var(--font-heading), sans-serif;
    font-weight: 700;
    font-size: 1rem;
    color: black;
    line-height: 1.3;
    margin: 0;
    transition: color 0.3s ease;
  }

  .award-card:hover .award-title {
    color: #f97316;
  }

  .award-organizer {
    font-size: 0.875rem;
    color: black;
    margin: 0;
    line-height: 1.4;
  }

  .award-date {
    font-size: 0.8rem;
    color: black;
    margin: 0;
  }

  @media (max-width: 639px) {
    .award-card {
      min-height: 100px;
    }

    .award-logo-container {
      width: 20%;
      min-width: 70px;
      padding: 0.75rem;
    }

    .award-details {
      padding: 0.75rem 1rem;
    }

    .award-title {
      font-size: 0.9rem;
    }

    .award-organizer {
      font-size: 0.8rem;
    }

    .award-date {
      font-size: 0.75rem;
    }
  }

  /* Toggle Button Container */
  .awards-toggle-container {
    display: flex;
    justify-content: center;
    margin-top: 2.5rem;
  }

  /* Toggle Button - styled like Hero Download CV */
  .awards-toggle-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: #f97316;
    color: white;
    font-weight: 600;
    border: 2px solid transparent;
    border-radius: 64px;
    box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
    cursor: pointer;
    transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1),
                background-color 200ms cubic-bezier(0.4, 0, 0.2, 1),
                color 200ms cubic-bezier(0.4, 0, 0.2, 1),
                border-color 200ms cubic-bezier(0.4, 0, 0.2, 1),
                border-radius 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .awards-toggle-btn:hover {
    background: white;
    color: #f97316;
    border-color: #f97316;
    transform: scale(1.03);
    border-radius: 1rem;
  }

  .toggle-icon {
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.3s ease;
  }

  .awards-toggle-btn[aria-expanded="true"] .toggle-icon {
    transform: rotate(180deg);
  }

  @media (min-width: 1024px) {
    .awards-toggle-btn {
      padding: 1rem 2rem;
    }
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // --- Cleanup function for GSAP animations ---
  let awardsAnimCleanup = () => {};
  let awardsToggleInit = false;

  function initAwardsAnimations() {
    awardsAnimCleanup();

    const initialCards = document.querySelectorAll('[data-initial-card]');
    if (!initialCards.length) return;

    // Set initial state to visible
    gsap.set(initialCards, { opacity: 1, y: 0, scale: 1 });

    const mm = gsap.matchMedia();

    mm.add("(min-width: 1024px)", () => {
      gsap.fromTo(initialCards, 
        { y: 40, opacity: 0, scale: 0.98 },
        {
          scrollTrigger: {
            trigger: initialCards[0],
            start: 'top 85%',
            toggleActions: 'play none none none'
          },
          y: 0,
          opacity: 1,
          scale: 1,
          duration: 0.6,
          stagger: 0.08,
          ease: 'power2.out'
        }
      );
    });

    mm.add("(min-width: 640px) and (max-width: 1023px)", () => {
      gsap.fromTo(initialCards, 
        { y: 30, opacity: 0 },
        {
          scrollTrigger: {
            trigger: initialCards[0],
            start: 'top 85%',
            toggleActions: 'play none none none'
          },
          y: 0,
          opacity: 1,
          duration: 0.5,
          stagger: 0.08,
          ease: 'power2.out'
        }
      );
    });

    mm.add("(max-width: 639px)", () => {
      gsap.fromTo(initialCards, 
        { opacity: 0 },
        {
          scrollTrigger: {
            trigger: initialCards[0],
            start: 'top 90%',
            toggleActions: 'play none none none'
          },
          opacity: 1,
          duration: 0.4,
          stagger: 0.06
        }
      );
    });

    awardsAnimCleanup = () => {
      mm.revert();
    };
  }

  // --- Event Delegation for toggle button (added ONCE, never re-added) ---
  function initAwardsToggleDelegation() {
    if (awardsToggleInit) return;
    awardsToggleInit = true;

    document.addEventListener('click', (e) => {
      const toggleBtn = (e.target as HTMLElement).closest('#awards-toggle-btn');
      if (!toggleBtn) return;

      const additionalCards = document.querySelectorAll('[data-additional-card]');
      if (!additionalCards.length) return;

      const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
      const toggleText = toggleBtn.querySelector('.toggle-text');

      if (!isExpanded) {
        // Show More - expand cards
        toggleBtn.setAttribute('aria-expanded', 'true');
        if (toggleText) toggleText.textContent = 'Show Less';

        // Show cards with stagger animation
        additionalCards.forEach(card => {
          (card as HTMLElement).style.display = 'flex';
        });

        gsap.fromTo(additionalCards,
          { 
            opacity: 0, 
            y: 30,
            scale: 0.95
          },
          {
            opacity: 1,
            y: 0,
            scale: 1,
            duration: 0.5,
            stagger: 0.1,
            ease: 'power2.out'
          }
        );
      } else {
        // Show Less - collapse cards
        toggleBtn.setAttribute('aria-expanded', 'false');
        if (toggleText) toggleText.textContent = 'Show More';

        // Hide cards with reverse stagger animation
        gsap.to(additionalCards,
          {
            opacity: 0,
            y: -20,
            scale: 0.95,
            duration: 0.4,
            stagger: 0.05,
            ease: 'power2.in',
            onComplete: () => {
              additionalCards.forEach(card => {
                (card as HTMLElement).style.display = 'none';
              });
            }
          }
        );
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initAwardsAnimations();
      initAwardsToggleDelegation();
    });
  } else {
    initAwardsAnimations();
    initAwardsToggleDelegation();
  }

  document.addEventListener('astro:page-load', () => {
    initAwardsAnimations();
    initAwardsToggleDelegation();
  });
</script>
