---
import { getCollection } from 'astro:content';
import SectionHeading from '../ui/SectionHeading.astro';
import { getColorByIndex } from '../../constants/theme';

const base = import.meta.env.BASE_URL;
// Ensure base ends with / for proper path joining
const baseUrl = base.endsWith('/') ? base : `${base}/`;

// Get all experiences and sort by order
const experiencesRaw = (await getCollection('experiences'))
  .sort((a, b) => a.data.order - b.data.order);

// Render content to extract bullet points
const experiences = await Promise.all(
  experiencesRaw.map(async (exp) => {
    const { Content } = await exp.render();
    return {
      ...exp,
      Content
    };
  })
);
---

<section id="experience" class="experience-timeline-section py-16 pb-24">
  <div class="timeline-section-container">
    <SectionHeading 
      title="Work Experience"
      showDetailButton={false}
    />

    <!-- Timeline Container -->
    <div class="timeline-container" id="experienceTimeline">
      <!-- Timeline Line -->
      <div class="timeline-line">
        <div class="timeline-line-base"></div>
        <div class="timeline-line-progress" id="timelineProgress"></div>
      </div>

      <!-- Experience Cards -->
      {experiences.map((exp, index) => (
        <div class="timeline-item" data-timeline-item={index}>
          <!-- Dot and Date Badge -->
          <div class="timeline-marker" data-timeline-marker={index}>
            <div class="timeline-dot">
              <div class="timeline-dot-inner"></div>
            </div>
            <div class="timeline-date-badge" data-color-index={index % 8}>
              <div class="date-start">{exp.data.startDate}</div>
              <div class="date-separator-line">
                <span class="date-separator">-</span>
                <span class="date-end">{exp.data.endDate || 'Present'}</span>
              </div>
            </div>
          </div>

          <!-- Card -->
          <div class="timeline-card" data-color-index={index % 8}>
            <!-- Card Header: Logo + Info + Button -->
            <div class="card-header">
              <div class="card-icon">
                <img 
                  src={`${baseUrl}${exp.data.image}`}
                  alt={`${exp.data.company} logo`}
                  loading="lazy"
                />
              </div>
              <div class="card-info">
                <h3 class="card-company">{exp.data.company}</h3>
                <p class="card-position">{exp.data.title}</p>
                <p class="card-mobile-date" data-color-index={index % 8}>
                  {exp.data.startDate} - {exp.data.endDate || 'Present'}
                </p>
              </div>
            </div>

            <!-- Description -->
            <div class="card-description">
              <exp.Content />
            </div>

            <!-- Tech Stack -->
            <div class="card-tech-stack">
              {exp.data.techStack.map((tech: string) => (
                <span class="tech-badge" data-color-index={index % 8}>{tech}</span>
              ))}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  .experience-timeline-section {
    width: 100%;
    overflow: hidden;
  }

  .timeline-section-container {
    max-width: 72rem;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .timeline-container {
    position: relative;
    margin-top: 2rem;
    padding-left: 12rem;
  }

  /* Timeline Line */
  .timeline-line {
    position: absolute;
    left: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
  }

  .timeline-line-base {
    position: absolute;
    inset: 0;
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 1px;
  }

  .timeline-line-progress {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 0%;
    background: #ff991c;
    border-radius: 1px;
    transition: height 0.1s ease-out;
  }

  /* Timeline Item */
  .timeline-item {
    position: relative;
    margin-bottom: 2rem;
  }

  .timeline-item:last-child {
    margin-bottom: 0;
  }

  /* Timeline Marker (Dot + Date) */
  .timeline-marker {
    position: absolute;
    left: -11rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    top: 1.25rem;
  }

  .timeline-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background-color: #6B7280;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    z-index: 10;
    position: relative;
    left: -0.375rem;
  }

  .timeline-dot-inner {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #ffffff;
  }

  .timeline-date-badge {
    font-size: 0.875rem;
    color: #000000;
    font-weight: 600;
    background-color: #ffffff;
    border: 2px solid #000000;
    border-radius: 9999px;
    padding: 0.375rem 0.75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    line-height: 1.2;
  }
  
  /* Color variants for date badges */
  .timeline-date-badge[data-color-index="0"] { border-color: #6366f1; } /* indigo */
  .timeline-date-badge[data-color-index="1"] { border-color: #f97316; } /* orange */
  .timeline-date-badge[data-color-index="2"] { border-color: #3b82f6; } /* blue */
  .timeline-date-badge[data-color-index="3"] { border-color: #a855f7; } /* purple */
  .timeline-date-badge[data-color-index="4"] { border-color: #22c55e; } /* green */
  .timeline-date-badge[data-color-index="5"] { border-color: #ec4899; } /* pink */
  .timeline-date-badge[data-color-index="6"] { border-color: #06b6d4; } /* cyan */
  .timeline-date-badge[data-color-index="7"] { border-color: #f59e0b; } /* amber */

  .date-start,
  .date-end {
    white-space: nowrap;
  }
  
  .date-separator-line {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
  }

  .date-separator {
    white-space: nowrap;
  }

  /* Timeline Card */
  .timeline-card {
    background: #ffffff;
    border: 2px solid #000000;
    border-right-width: 6px;
    border-radius: 1rem;
    padding: 1.5rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  /* Color variants for card right border */
  .timeline-card[data-color-index="0"] { border-right-color: #6366f1; } /* indigo */
  .timeline-card[data-color-index="1"] { border-right-color: #f97316; } /* orange */
  .timeline-card[data-color-index="2"] { border-right-color: #3b82f6; } /* blue */
  .timeline-card[data-color-index="3"] { border-right-color: #a855f7; } /* purple */
  .timeline-card[data-color-index="4"] { border-right-color: #22c55e; } /* green */
  .timeline-card[data-color-index="5"] { border-right-color: #ec4899; } /* pink */
  .timeline-card[data-color-index="6"] { border-right-color: #06b6d4; } /* cyan */
  .timeline-card[data-color-index="7"] { border-right-color: #f59e0b; } /* amber */

  .timeline-card:hover {
    transform: translateY(-8px) !important;
    box-shadow: 0px 4px 0px 0px rgba(0, 0, 0, 1);
  }

  /* Card Header */
  .card-header {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .card-icon {
    width: 2.5rem;
    height: 2.5rem;
    flex-shrink: 0;
    border-radius: 0.5rem;
    overflow: hidden;
    background: #f3f4f6;
    padding: 0.25rem;
  }

  .card-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .card-info {
    flex: 1;
    min-width: 0;
  }

  .card-company {
    font-size: 1rem;
    font-weight: 700;
    color: #000000;
    margin: 0;
    line-height: 1.3;
  }

  .card-position {
    font-size: 0.875rem;
    font-weight: 700;
    color: #000000;
    margin: 0.125rem 0 0 0;
    opacity: 0.8;
  }
  
  .card-mobile-date {
    font-size: 0.75rem;
    font-weight: 600;
    color: #000000;
    margin: 0.375rem 0 0 0;
    padding: 0.25rem 0.625rem;
    background-color: #ffffff;
    border: 2px solid #000000;
    border-radius: 9999px;
    display: inline-block;
    width: fit-content;
  }
  
  /* Color variants for mobile date */
  .card-mobile-date[data-color-index="0"] { border-color: #6366f1; background-color: #e0e7ff; }
  .card-mobile-date[data-color-index="1"] { border-color: #f97316; background-color: #ffedd5; }
  .card-mobile-date[data-color-index="2"] { border-color: #3b82f6; background-color: #dbeafe; }
  .card-mobile-date[data-color-index="3"] { border-color: #a855f7; background-color: #f3e8ff; }
  .card-mobile-date[data-color-index="4"] { border-color: #22c55e; background-color: #dcfce7; }
  .card-mobile-date[data-color-index="5"] { border-color: #ec4899; background-color: #fce7f3; }
  .card-mobile-date[data-color-index="6"] { border-color: #06b6d4; background-color: #cffafe; }
  .card-mobile-date[data-color-index="7"] { border-color: #f59e0b; background-color: #fef3c7; }

  /* Card Description */
  .card-description {
    color: #000000;
    font-size: 0.875rem;
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  /* Hide the h2 heading from markdown */
  .card-description :global(h2) {
    display: none;
  }

  .card-description :global(ul) {
    list-style: disc;
    padding-left: 1.25rem;
    margin: 0;
  }

  .card-description :global(li) {
    margin-bottom: 0.375rem;
  }

  .card-description :global(li:last-child) {
    margin-bottom: 0;
  }

  .card-description :global(p) {
    margin: 0;
  }

  /* Tech Stack */
  .card-tech-stack {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .tech-badge {
    padding: 0.25rem 0.625rem;
    background-color: #ffffff;
    color: #000000;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 9999px;
    border: 2px solid #000000;
  }
  
  /* Color variants for tech badges */
  .tech-badge[data-color-index="0"] { 
    border-color: #6366f1; 
    background-color: #e0e7ff; /* light indigo */
  }
  .tech-badge[data-color-index="1"] { 
    border-color: #f97316; 
    background-color: #ffedd5; /* light orange */
  }
  .tech-badge[data-color-index="2"] { 
    border-color: #3b82f6; 
    background-color: #dbeafe; /* light blue */
  }
  .tech-badge[data-color-index="3"] { 
    border-color: #a855f7; 
    background-color: #f3e8ff; /* light purple */
  }
  .tech-badge[data-color-index="4"] { 
    border-color: #22c55e; 
    background-color: #dcfce7; /* light green */
  }
  .tech-badge[data-color-index="5"] { 
    border-color: #ec4899; 
    background-color: #fce7f3; /* light pink */
  }
  .tech-badge[data-color-index="6"] { 
    border-color: #06b6d4; 
    background-color: #cffafe; /* light cyan */
  }
  .tech-badge[data-color-index="7"] { 
    border-color: #f59e0b; 
    background-color: #fef3c7; /* light amber */
  }

  /* ==================
     RESPONSIVE STYLES
     ================== */

  /* Mobile - Hide timeline badge only, show card mobile date, keep timeline line and dot */
  @media (max-width: 639px) {
    .timeline-date-badge {
      display: none;
    }
    
    .timeline-container {
      padding-left: 2rem;
    }
    
    .timeline-marker {
      left: -1.5rem;
    }
    
    .card-mobile-date {
      display: inline-block;
    }
  }
  
  /* Tablet and Desktop - Show timeline badge, hide card mobile date */
  @media (min-width: 640px) {
    .card-mobile-date {
      display: none;
    }
  }

  /* Tablet */
  @media (min-width: 640px) {
    .timeline-section-container {
      padding: 0 2rem;
    }

    .timeline-container {
      padding-left: 14rem;
    }

    .timeline-line {
      left: 1.25rem;
    }

    .timeline-marker {
      left: -12.75rem;
    }

    .timeline-dot {
      width: 16px;
      height: 16px;
      left: -0.4375rem;
    }

    .timeline-dot-inner {
      width: 8px;
      height: 8px;
    }

    .timeline-date-badge {
      font-size: 0.9375rem;
    }

    .timeline-card {
      padding: 1.75rem;
    }

    .card-icon {
      width: 3rem;
      height: 3rem;
    }

    .card-company {
      font-size: 1.125rem;
    }

    .card-position {
      font-size: 0.9375rem;
    }

    .card-description {
      font-size: 0.9375rem;
    }
  }

  /* Desktop */
  @media (min-width: 1024px) {
    .timeline-section-container {
      padding: 0 3rem;
    }

    .timeline-container {
      padding-left: 16rem;
    }

    .timeline-line {
      left: 1.5rem;
    }

    .timeline-marker {
      left: -14.5rem;
    }

    .timeline-dot {
      width: 18px;
      height: 18px;
      left: -0.5rem;
    }

    .timeline-dot-inner {
      width: 9px;
      height: 9px;
    }

    .timeline-date-badge {
      font-size: 1rem;
    }

    .timeline-card {
      padding: 2rem;
    }

    .card-icon {
      width: 3.5rem;
      height: 3.5rem;
      padding: 0.375rem;
    }

    .card-company {
      font-size: 1.25rem;
    }

    .card-position {
      font-size: 1rem;
    }

    .card-description {
      font-size: 1rem;
    }

    .tech-badge {
      padding: 0.3125rem 0.75rem;
      font-size: 0.8125rem;
    }
  }

  /* Mobile - Narrow layout */
  @media (max-width: 639px) {
    .timeline-section-container {
      padding: 0 0.75rem;
    }

    .timeline-container {
      padding-left: 6.5rem;
    }

    .timeline-line {
      left: 0.5rem;
    }

    .timeline-marker {
      left: -6rem;
      gap: 0.375rem;
    }

    .timeline-dot {
      width: 12px;
      height: 12px;
      left: -0.3125rem;
    }

    .timeline-dot-inner {
      width: 6px;
      height: 6px;
    }

    .timeline-date {
      font-size: 0.625rem;
      min-width: 4.5rem;
      display: flex;
      flex-direction: column;
      line-height: 1.4;
    }

    .date-separator {
      display: none;
    }

    .date-end::before {
      content: '- ';
    }

    .timeline-card {
      padding: 1rem;
    }

    .card-header {
      flex-wrap: wrap;
    }

    .card-description {
      font-size: 0.75rem;
    }

    .tech-badge {
      padding: 0.188rem 0.375rem;
      font-size: 0.688rem;
    }
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  function initExperienceTimeline() {
    const container = document.getElementById('experienceTimeline');
    const progressLine = document.getElementById('timelineProgress');
    const items = document.querySelectorAll('[data-timeline-item]');
    const markers = document.querySelectorAll('[data-timeline-marker]');
    
    if (!container || !progressLine || items.length === 0) return;

    // Kill existing ScrollTriggers for this component
    ScrollTrigger.getAll().forEach(st => {
      if (st.vars.id?.startsWith('exp-timeline')) {
        st.kill();
      }
    });

    const itemsArray = Array.from(items);
    const markersArray = Array.from(markers) as HTMLElement[];
    const totalItems = itemsArray.length;
    const segmentSize = 1 / totalItems;

    // Pre-resolve card/marker elements once
    const itemData = itemsArray.map((item, index) => {
      const card = item.querySelector('.timeline-card') as HTMLElement;
      const marker = markersArray[index];
      return { item, card, marker };
    });

    // Cache layout measurements (offsetHeight) â€” updated on init & resize
    let cachedRanges: number[] = [];

    function cacheHeights() {
      cachedRanges = itemData.map(({ card, marker }) => {
        if (!card || !marker) return 0;
        return card.offsetHeight - marker.offsetHeight - 16; // 16px bottom padding
      });
    }

    cacheHeights();

    // Recache on resize (debounced by ScrollTrigger.refresh)
    ScrollTrigger.addEventListener('refresh', cacheHeights);

    // Main scroll progress for the line fill
    ScrollTrigger.create({
      id: 'exp-timeline-progress',
      trigger: container,
      start: 'top 70%',
      end: 'bottom 30%',
      scrub: 0.5,
      onUpdate: (self) => {
        gsap.set(progressLine, {
          height: `${self.progress * 100}%`
        });
      }
    });

    // Sequential animation for markers
    // Each marker moves within its card height, but only after the previous one completes
    itemData.forEach(({ item, card, marker }, index) => {
      if (!marker || !card) return;

      // Each item gets an equal portion of the total scroll
      const startProgress = index * segmentSize;
      const endProgress = (index + 1) * segmentSize;

      // Create ScrollTrigger for sequential marker movement
      ScrollTrigger.create({
        id: `exp-timeline-marker-${index}`,
        trigger: container,
        start: 'top 70%',
        end: 'bottom 30%',
        scrub: 0.3,
        onUpdate: (self) => {
          // Calculate the normalized progress for this specific item
          let itemProgress = 0;
          
          if (self.progress >= endProgress) {
            itemProgress = 1;
          } else if (self.progress > startProgress) {
            itemProgress = (self.progress - startProgress) / segmentSize;
          }

          // Use cached range instead of reading offsetHeight every frame
          const yPos = itemProgress * cachedRanges[index];
          
          gsap.set(marker, { y: yPos });
        }
      });

      // Card entrance animation
      gsap.from(card, {
        scrollTrigger: {
          id: `exp-timeline-card-${index}`,
          trigger: item,
          start: 'top 85%',
          toggleActions: 'play none none reverse'
        },
        opacity: 0,
        x: 30,
        duration: 0.6,
        delay: index * 0.1,
        ease: 'power2.out'
      });
    });

    // Refresh triggers (also fires the 'refresh' event which recaches heights)
    ScrollTrigger.refresh();
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExperienceTimeline);
  } else {
    initExperienceTimeline();
  }

  // Re-initialize on Astro navigation
  document.addEventListener('astro:page-load', initExperienceTimeline);
</script>
