---
import SectionHeading from '../ui/SectionHeading.astro';
import { THEME_COLORS, type ColorKey } from '../../constants/theme';

// Get base URL for proper routing
const base = import.meta.env.BASE_URL;
const baseUrl = base.endsWith('/') ? base : `${base}/`;

interface TechItem {
  name: string;
  icon: string | null;
}

interface TechCategory {
  title: string;
  color: ColorKey;
  items: TechItem[];
}

// Tech stack organized by categories
const techStackCategories: TechCategory[] = [
  {
    title: 'Frontend',
    color: 'blue',
    items: [
      { name: 'React', icon: `${baseUrl}images/tech-stack/react.svg` },
      { name: 'Tailwind', icon: `${baseUrl}images/tech-stack/tailwind.svg` },
      { name: 'Bootstrap', icon: `${baseUrl}images/tech-stack/bootstrap.svg` },
    ]
  },
  {
    title: 'Backend',
    color: 'green',
    items: [
      { name: 'Laravel', icon: `${baseUrl}images/tech-stack/laravel.svg` },
      { name: 'FastAPI', icon: `${baseUrl}images/tech-stack/fastapi.svg` },
      { name: 'Go Gin', icon: `${baseUrl}images/tech-stack/go-gin.webp` },
      { name: 'Go Huma', icon: `${baseUrl}images/tech-stack/go-huma.webp` },
    ]
  },
  {
    title: 'Mobile',
    color: 'purple',
    items: [
      { name: 'Flutter', icon: `${baseUrl}images/tech-stack/flutter.svg` },
      { name: 'React Native', icon: `${baseUrl}images/tech-stack/react-native.svg` },
    ]
  },
  {
    title: 'Database',
    color: 'orange',
    items: [
      { name: 'MySQL', icon: `${baseUrl}images/tech-stack/mysql.svg` },
      { name: 'PostgreSQL', icon: `${baseUrl}images/tech-stack/postgresql.svg` },
    ]
  },
  {
    title: 'CI & CD, DevOps',
    color: 'cyan',
    items: [
      { name: 'Github Action', icon: `${baseUrl}images/tech-stack/github-actions.svg` },
      { name: 'Docker', icon: `${baseUrl}images/tech-stack/docker.svg` },
      { name: 'SonarQube', icon: `${baseUrl}images/tech-stack/sonarqube.svg` },
    ]
  },
  {
    title: 'Amazon Web Service',
    color: 'amber',
    items: [
      { name: 'Lambda', icon: `${baseUrl}images/tech-stack/lambda.png` },
      { name: 'DynamoDB', icon: `${baseUrl}images/tech-stack/dynamodb.png` },
      { name: 'IAM', icon: `${baseUrl}images/tech-stack/iam.png` },
      { name: 'API Gateway', icon: `${baseUrl}images/tech-stack/api-gateway.png` },
      { name: 'S3', icon: `${baseUrl}images/tech-stack/s3.png` },
      { name: 'Cognito', icon: `${baseUrl}images/tech-stack/cognito.png` },
    ]
  },
  {
    title: 'Artificial Intelligence Libraries',
    color: 'pink',
    items: [
      { name: 'TensorFlow', icon: `${baseUrl}images/tech-stack/tensorflow.svg` },
      { name: 'PyTorch', icon: `${baseUrl}images/tech-stack/pytorch.svg` },
      { name: 'XGBoost', icon: `${baseUrl}images/tech-stack/xgboost.png` },
      { name: 'Scikit-learn', icon: `${baseUrl}images/tech-stack/scikit-learn.svg` },
      { name: 'Ultralytics', icon: `${baseUrl}images/tech-stack/ultralytics.jpeg` },
    ]
  },
  {
    title: 'Artificial Intelligence Models',
    color: 'indigo',
    items: [
      { name: 'Semantic Segmentation', icon: null },
      { name: 'Forecasting', icon: null },
    ]
  },
];
---

<section id="tech-stack" class="techstack-section">
  <div class="techstack-container">
    <!-- Top Spacer -->
    <div class="section-spacer-top"></div>
    
    <SectionHeading 
      title="Tech Stack"
      showDetailButton={false}
    />
    <div class="section-spacer-bottom"></div>

    <!-- True Masonry with CSS Columns -->
    <div class="masonry-columns">
      {techStackCategories.map((category, categoryIndex) => (
        <div 
          class={`tech-card card-${categoryIndex}`}
          style={`
            border-color: ${THEME_COLORS[category.color].border};
            --hover-bg: ${THEME_COLORS[category.color].hover};
          `}
        >
          <!-- Hover Background Overlay -->
          <div class="card-hover-bg"></div>
          
          <!-- Card Content -->
          <div class="card-content">
            <!-- Category Title (inside card, top-left) -->
            <h3 class="card-title" style="font-family: 'Quantico', sans-serif;">
              {category.title}
            </h3>

          <!-- Tech Badges -->
          <div class="badges-container">
            {category.items.map((tech, techIndex) => (
              <div 
                class={`tech-badge badge-${category.color}`}
                data-category={categoryIndex}
                data-tech={techIndex}
                style={`
                  background-color: ${THEME_COLORS[category.color].light};
                  border-color: ${THEME_COLORS[category.color].border};
                  --hover-bg: ${THEME_COLORS[category.color].hover};
                `}
              >
                {tech.icon ? (
                  <div class="tech-icon-container">
                    <img 
                      src={tech.icon} 
                      alt={tech.name}
                      class="tech-icon"
                      loading="lazy"
                    />
                  </div>
                ) : (
                  <div class="tech-icon-placeholder"></div>
                )}
                <span class="tech-name">{tech.name}</span>
              </div>
            ))}
          </div>
          </div>
        </div>
      ))}
    </div>
        
  </div>
</section>

<style>
  .techstack-section {
    width: 100%;
    overflow: hidden;
  }

  .techstack-container {
    max-width: 72rem;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* True Masonry with CSS Columns - independent vertical stacks */
  .masonry-columns {
    columns: 2;
    column-gap: 1.5rem;
  }

  /* Card with transparent background and 3px border */
  .tech-card {
    position: relative;
    background-color: transparent;
    border: 3px solid;
    border-radius: 1rem;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    break-inside: avoid;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
  }
  
  /* Hover background wipe from top */
  .card-hover-bg {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--hover-bg);
    transform: scaleY(0);
    transform-origin: top;
    transition: transform 1s ease;
    z-index: 0;
    border-radius: calc(1rem - 3px);
  }
  
  .tech-card:hover .card-hover-bg {
    transform: scaleY(1);
  }
  
  /* Card content needs higher z-index */
  .card-content {
    position: relative;
    z-index: 1;
  }

  .tech-card:hover {
    transform: translateY(-8px) !important;
    box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
  }

  /* Card Title */
  .card-title {
    color: #000000;
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 0.625rem;
    text-align: left;
    transition: color 0.5s ease;
  }
  
  .tech-card:hover .card-title {
    color: #ffffff;
  }

  /* Badges Container */
  .badges-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  /* Tech Badge - Pill Shape */
  .tech-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.875rem;
    border-radius: 9999px;
    border: 2px solid;
    transition: all 0.3s ease;
    cursor: default;
  }

  .tech-badge:hover {
    background-color: var(--hover-bg) !important;
    border-color: var(--hover-bg) !important;
  }

  .tech-badge:hover .tech-name {
    color: #ffffff;
  }

  /* Tech Icon */
  .tech-icon-container {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .tech-icon {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
  }

  .tech-icon-placeholder {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
  }

  /* Tech Name */
  .tech-name {
    color: #000000;
    font-size: 0.8125rem;
    font-weight: 600;
    white-space: nowrap;
    transition: color 0.3s ease;
  }

  /* ==================
     RESPONSIVE STYLES
     ================== */

  /* Tablet */
  @media (min-width: 640px) {
    .techstack-container {
      padding: 0 2rem;
    }

    .section-spacer-top {
      height: 4.5rem; /* 128px */
    }

    .section-spacer-bottom {
      height: 1.5rem; /* 80px */
    }

    .card-title {
      font-size: 1.25rem;
    }

    .tech-badge {
      padding: 0.375rem 1rem;
    }

    .tech-icon-container {
      width: 22px;
      height: 22px;
    }

    .tech-name {
      font-size: 0.875rem;
    }
  }

  /* Desktop */
  @media (min-width: 1024px) {
    .techstack-container {
      padding: 0 3rem;
    }

    .section-spacer-top {
      height: 4.5rem; /* 160px */
    }

    .section-spacer-bottom {
      height: 1.5rem; /* 96px */
    }

    .masonry-columns {
      column-gap: 2rem;
    }

    .tech-card {
      padding: 1.75rem;
      margin-bottom: 2rem;
    }

    .card-title {
      font-size: 1.375rem;
      margin-bottom: 1.25rem;
    }

    .badges-container {
      gap: 0.625rem;
    }

    .tech-badge {
      padding: 0.625rem 1.125rem;
    }

    .tech-icon-container {
      width: 24px;
      height: 24px;
    }

    .tech-name {
      font-size: 0.9375rem;
    }
  }

  /* Mobile - Single Column */
  @media (max-width: 639px) {
    .techstack-container {
      padding: 0 1rem;
    }

    .section-spacer-top {
      height: 2.25rem; /* 64px */
    }

    .section-spacer-bottom {
      height: 0.75rem; /* 48px */
    }

    .masonry-columns {
      columns: 1;
      column-gap: 0;
    }

    .tech-card {
      padding: 1.25rem;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    .badges-container {
      gap: 0.375rem;
    }

    .tech-badge {
      padding: 0.375rem 0.75rem;
      gap: 0.375rem;
    }

    .tech-icon-container {
      width: 18px;
      height: 18px;
    }

    .tech-icon-placeholder {
      width: 18px;
      height: 18px;
    }

    .tech-name {
      font-size: 0.75rem;
    }
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  let techStackCleanup = () => {};

  function initTechStackAnimations() {
    // Kill previous ScrollTrigger instances for this component
    techStackCleanup();

    const cards = document.querySelectorAll('.tech-card');
    const tweens: gsap.core.Tween[] = [];
    
    cards.forEach((card, cardIndex) => {
      const badges = card.querySelectorAll('.tech-badge');
      
      // Set initial state for card
      gsap.set(card, { opacity: 0, y: 30 });
      
      // Card entrance animation
      const cardTween = gsap.to(card, {
        scrollTrigger: {
          trigger: card,
          start: 'top 85%',
          toggleActions: 'play none none none'
        },
        opacity: 1,
        y: 0,
        duration: 0.5,
        delay: cardIndex * 0.05,
        ease: 'power2.out'
      });
      tweens.push(cardTween);

      // Set initial state for badges and animate them
      if (badges.length > 0) {
        gsap.set(badges, { opacity: 0, scale: 0.9 });
        
        const badgeTween = gsap.to(badges, {
          scrollTrigger: {
            trigger: card,
            start: 'top 80%',
            toggleActions: 'play none none none'
          },
          opacity: 1,
          scale: 1,
          duration: 0.3,
          stagger: {
            amount: 0.4,
            from: 'start'
          },
          delay: 0.15 + cardIndex * 0.05,
          ease: 'power2.out'
        });
        tweens.push(badgeTween);
      }
    });

    techStackCleanup = () => {
      tweens.forEach(t => {
        t.scrollTrigger?.kill();
        t.kill();
      });
    };
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTechStackAnimations);
  } else {
    initTechStackAnimations();
  }

  // Re-initialize on Astro navigation
  document.addEventListener('astro:page-load', initTechStackAnimations);
</script>
